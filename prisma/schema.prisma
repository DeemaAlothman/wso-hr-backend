generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// ENUMS
// =========================

enum Gender {
  male
  female
  other
}

enum LeaveRequestStatus {
  pending_manager
  approved_manager
  rejected_manager
  pending_hr
  approved_hr
  rejected_hr
  cancelled
  on_hold
}

enum HalfDayPeriod {
  morning
  afternoon
}

enum HolidayType {
  religious
  national
  special
  seasonal
}

enum NotificationType {
  system
  leave
  hr
  security
}

enum ActivityAction {
  login
  logout
  create
  update
  delete
  approve
  reject
  cancel
  upload
  assign_role
  remove_role
}

// =========================
// USERS / ROLES / DEPARTMENTS
// =========================

model Department {
  id          Int     @id @default(autoincrement())
  name        String
  code        String  @unique
  description String?
  isActive    Boolean @default(true)

  parentId Int?
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Department[] @relation("DepartmentHierarchy")

  managerId Int?
  manager   WsoSysUser? @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)

  users WsoSysUser[] @relation("UsersDepartment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([managerId])
  @@map("departments")
}

model WsoSysUser {
  id Int @id @default(autoincrement())

  userLogin    String  @unique
  email        String  @unique
  passwordHash String
  isActive     Boolean @default(true)

  displayName String?
  firstName   String?
  lastName    String?

  phone       String?
  mobile      String?
  birthDate   DateTime?
  gender      Gender?
  nationality String?
  nationalId  String?

  employeeNo String?   @unique
  position   String?
  hireDate   DateTime?

  departmentId Int?
  department   Department? @relation("UsersDepartment", fields: [departmentId], references: [id], onDelete: SetNull)

  avatarUrl    String?
  signatureUrl String?

  lastLoginAt        DateTime?
  lastLoginIp        String?
  lastLoginUserAgent String?

  roles         WsoUserRole[]
  activityLogs  ActivityLog[]
  notifications Notification[] @relation("NotificationRecipient")

  leaveBalances       HrLeaveBalance[]
  leaveBalanceHistory HrLeaveBalanceHistory[]
  leaveRequests       HrLeaveRequest[]        @relation("LeaveRequestRequester")
  managedDepartments  Department[]            @relation("DepartmentManager")

  managedLeaveRequests       HrLeaveRequest[] @relation("LeaveRequestManager")
  hrReviewedLeaveRequests    HrLeaveRequest[] @relation("LeaveRequestHROfficer")
  substituteForLeaveRequests HrLeaveRequest[] @relation("LeaveRequestSubstitute")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
  @@map("wso_sys_users")
}

model WsoRole {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)

  users           WsoUserRole[]
  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wso_roles")
}

model WsoUserRole {
  id     Int @id @default(autoincrement())
  userId Int
  roleId Int

  user WsoSysUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  role WsoRole    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())
  assignedBy Int?

  @@unique([userId, roleId])
  @@index([roleId])
  @@map("wso_users_roles")
}

// =========================
// OPTIONAL: PERMISSIONS
// =========================

model Permission {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?

  roleLinks RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("permissions")
}

model RolePermission {
  id           Int @id @default(autoincrement())
  roleId       Int
  permissionId Int

  role       WsoRole    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

// =========================
// HR: Leave Types / Balance / Requests / Holidays
// =========================

model HrLeaveType {
  id            Int     @id @default(autoincrement())
  leaveTypeName String
  leaveTypeCode String  @unique
  description   String?

  annualEntitlement  Int @default(0)
  maxConsecutiveDays Int @default(0)

  requiresApproval   Boolean @default(true)
  requiresAttachment Boolean @default(false)

  isPaid        Boolean @default(true)
  affectsSalary Boolean @default(false)

  isCarryoverAllowed Boolean @default(false)
  maxCarryoverDays   Int     @default(0)

  isActive Boolean @default(true)

  balances HrLeaveBalance[]
  requests HrLeaveRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hr_leave_types")
}

model HrLeaveBalance {
  id          Int @id @default(autoincrement())
  userId      Int
  leaveTypeId Int
  year        Int

  totalEntitlement Int @default(0)
  carriedOver      Int @default(0)
  usedBalance      Int @default(0)
  remainingBalance Int @default(0)

  user      WsoSysUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveType HrLeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)

  history HrLeaveBalanceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, leaveTypeId, year])
  @@index([leaveTypeId, year])
  @@map("hr_leave_balance")
}

model HrLeaveBalanceHistory {
  id           Int     @id @default(autoincrement())
  balanceId    Int
  changedById  Int?
  changeReason String?
  delta        Int     @default(0)
  before       Int     @default(0)
  after        Int     @default(0)
  meta         Json?

  balance   HrLeaveBalance @relation(fields: [balanceId], references: [id], onDelete: Cascade)
  changedBy WsoSysUser?    @relation(fields: [changedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([balanceId])
  @@index([changedById])
  @@map("hr_leave_balance_history")
}

model HrLeaveRequest {
  id            Int    @id @default(autoincrement())
  requestNumber String @unique

  userId      Int
  leaveTypeId Int

  startDate DateTime
  endDate   DateTime
  totalDays Int

  isHalfDay     Boolean        @default(false)
  halfDayPeriod HalfDayPeriod?

  reason      String?
  attachments Json?

  substituteUserId    Int?
  substituteStartDate DateTime?
  substituteEndDate   DateTime?
  substituteConfirmed Boolean   @default(false)

  contactDuringLeave String?
  status             LeaveRequestStatus @default(pending_manager)

  managerId           Int?
  managerApprovalDate DateTime?
  managerNotes        String?

  hrOfficerId    Int?
  hrApprovalDate DateTime?
  hrNotes        String?

  submittedDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user      WsoSysUser  @relation("LeaveRequestRequester", fields: [userId], references: [id], onDelete: Cascade)
  leaveType HrLeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)

  manager        WsoSysUser? @relation("LeaveRequestManager", fields: [managerId], references: [id], onDelete: SetNull)
  hrOfficer      WsoSysUser? @relation("LeaveRequestHROfficer", fields: [hrOfficerId], references: [id], onDelete: SetNull)
  substituteUser WsoSysUser? @relation("LeaveRequestSubstitute", fields: [substituteUserId], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([managerId, status])
  @@index([hrOfficerId, status])
  @@index([leaveTypeId])
  @@map("hr_leave_requests")
}

model HrAnnualHoliday {
  id          Int         @id @default(autoincrement())
  holidayName String
  holidayType HolidayType

  startDate DateTime
  endDate   DateTime
  totalDays Int

  isRecurring       Boolean @default(false)
  recurrencePattern String?
  description       String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startDate, endDate])
  @@map("hr_annual_holidays")
}

// =========================
// LOGS & NOTIFICATIONS
// =========================

model ActivityLog {
  id          Int            @id @default(autoincrement())
  userId      Int?
  action      ActivityAction
  entityType  String?
  entityId    String?
  description String?
  changes     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime       @default(now())

  user WsoSysUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@map("activity_logs")
}

model Notification {
  id          Int              @id @default(autoincrement())
  recipientId Int
  type        NotificationType @default(system)
  title       String
  message     String
  data        Json?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())

  recipient WsoSysUser @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead])
  @@map("notifications")
}

// =========================
// OPTIONAL: System Settings
// =========================

model SystemSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  updatedById Int?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@map("system_settings")
}
